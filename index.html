<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>disorient</title>
    <meta name="description" content="disorient">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
    <script src="./lib/util.js"></script>
    <style>
      #debug {
        position: absolute;
        background-color: #11111155;
        color: white;
        top: 5px;
        right: 5px;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <pre id="debug"></pre>
    <script>
      (() => {
        window.PLAYER = {}
        const debugWindow = document.getElementById('debug')

        AFRAME.registerComponent('camera-listener', {
          log : function () {
            var cameraEl = this.el.sceneEl.camera.el;
            var rotation = cameraEl.getAttribute('rotation');
            var worldPos = new THREE.Vector3();
            worldPos.setFromMatrixPosition(cameraEl.object3D.matrixWorld);
            window.PLAYER.position = worldPos
            window.PLAYER.position = worldPos
            const data =
              "Camera Position: (" + worldPos.x.toFixed(2) + ", " + worldPos.y.toFixed(2) + ", " + worldPos.z.toFixed(2) + ")\n" +
              "Camera Rotation: (" + rotation.x.toFixed(2) + ", " + rotation.y.toFixed(2) + ", " + rotation.z.toFixed(2) + ")"
            
            if (debugWindow.innerHTML !== data) {
              debugWindow.innerHTML = data
            }
          },

          play: function () {
            this.log();
          },

          tick: function () {
            this.log();
          },
        });
      })()
    </script>
    <a-scene>
      <a-assets>
        <img id="sky" src="./assets/sky-line.jpg">
        <img id="dark-grid" src="./assets/dark-grid.jpg">
        <img id="light-grid" src="./assets/light-grid.jpg">
      </a-assets>
      
      <!-- We can rotate and position the world to simulate artificial movement -->
      <a-entity id="world" position="0 0 0" rotation="0 0 0">

        <!-- Table -->
        <a-entity id="table" position="-0.7 1 -0.7" rotation="0 45 0">
          <a-box
            static-body 
            color="#FFFF00" src="#dark-grid" height="0.1" width="1.5" depth="0.75"></a-box>
          
          <!-- Stuff on table -->
          <!-- <a-cylinder
            class="throwable" dynamic-body 
            position="-1.11 1.25 -1.2" radius="0.05" height="0.15" color="#FF0000" src="#light-grid" repeat="5 5"></a-cylinder>
          <a-sphere
            dynamic-body 
            position="-1.27 1.16 -1.03" radius="0.05" src="#light-grid" repeat="10 10"></a-sphere>
          <a-box
            class="throwable" dynamic-body 
            position="-0.81 1.19 -1.32" rotation="0 45 0" color="#FFFF00" src="#light-grid" height="0.1" width="0.1" depth="0.1"></a-box> -->
        </a-entity>
        

        <!-- Background sky. -->
        <!-- <a-sky height="2048" radius="30" src="#light-grid" repeat="20 10" color="purple" theta-length="90" width="2048" position="0 0 0"></a-sky> -->
        <a-sky height="2048" radius="30" src="#sky" theta-length="90" width="2048" position="0 0 0" rotation="0 0 0" repeat="5 5" animation="property: rotation; to: 0 360 0; dur: 200000; easing: linear; loop: true"></a-sky>
        <a-entity light="type: ambient; color: #BBB" position="0 4 0"></a-entity>

        <!-- Ground -->
        <a-plane
          static-body
          rotation="-90 0 0"
          width="50"
          height="50"
          src="#dark-grid"
          material="repeat: 10 10"
        ></a-plane>


        <!-- Walls and junk -->
        <a-box static-body position="3 0 0" rotation="0 0 0" depth="6" height="2" width="0.25" color="#0000FF" src="#dark-grid" repeat="5 5"></a-box>
        <a-box static-body position="0 0 -3" rotation="0 90 0" depth="6" height="2" width="0.25" color="#FF00FF" src="#dark-grid" repeat="5 5"></a-box>
        <a-box static-body position="0 0 3" rotation="0 90 0" depth="6" height="2" width="0.25" color="#00FFFF" src="#dark-grid" repeat="5 5"></a-box>
        <a-box static-body position="-3 0 0" rotation="0 0 0" depth="6" height="2" width="0.25" color="#00FF00" src="#dark-grid" repeat="5 5"></a-box>
      </a-entity>

      <!-- Player -->
      <a-entity camera look-controls wasd-controls></a-entity>
      <a-entity
        id="leftController"
        static-body="shape: sphere; sphereRadius: 0.01;"
        vive-controls="hand: left"
        oculus-touch-controls="hand: left"
        sphere-collider="objects: .throwable"
        grab
        name="left-hand"
        ></a-entity>
        <a-entity
        id="rightController"
        static-body="shape: sphere; sphereRadius: 0.005;"
        vive-controls="hand: right"
        oculus-touch-controls="hand: right"
        sphere-collider="objects: .throwable"
        grab
        name="right-hand"
      ></a-entity>
    </a-scene>

    <script>
      const button = make({
        type: 'cylinder',
        under: '#table',
        staticBody,

        position: "0 .05 0",
        radius: "0.05",
        height: "0.1",
        color: "#FF0000",
        src: "#light-grid",
        repeat: "5 5",
      })

      button.addEventListener('collide', debounce((evt) => {
        const collider = evt.detail.body.el
        const name = collider.name || collider.getAttribute('name')
        
        if (name && name.includes('hand')) {
          newBlock()
        }
      }))

      make({
          name: 'test-hand',
          type: 'box',
          under: '#table',
          relative: true,
          
          class: "throwable",
          dynamicBody,
  
          position: "0 2 0",
          rotation: "0 45 0",
          color: "#0000FF",
          src: "#light-grid",
          height: "0.1",
          width: "0.1",
          depth: "0.1",
        })

      function newBlock () {
        return make({
          type: 'box',
          under: '#table',
          relative: true,
          
          class: "throwable",
          dynamicBody,
  
          position: randomTriad({ min: 0.15, max: [0.5, 0.2, 0.4], y: 0.2 }),
          rotation: "0 45 0",
          color: "#FFFF00",
          src: "#light-grid",
          height: "0.1",
          width: "0.1",
          depth: "0.1",
        })
      }

      newBlock()
      newBlock()
      newBlock()
      newBlock()
      newBlock()
      newBlock()
      newBlock()
      newBlock()
      newBlock()
    </script>
  </body>
</html>
